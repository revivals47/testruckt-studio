# Testruct Desktop Rust v0.9 → v1.0
## バグフィクス＆リファクタリング計画

**目標**：コード品質向上、技術負債削減、保守性向上
**対象**：教育現場向けテスト作成ツール
**期間**：Phase 1-5（段階的改善）

---

## Phase 1: コンパイル警告の解消（優先度: 高）

### 1.1 未使用インポート削除
- [ ] `crates/ui/src/window/actions/clipboard_actions.rs:6` - `std::rc::Rc`
- [ ] `crates/ui/src/window/actions/layer_actions.rs:4` - `gtk4::prelude::*`

**工数**：15分 | **影響**：低 | **効果**：コード清潔性

### 1.2 未使用変数の修正
- [ ] `crates/ui/src/panels/layers.rs:63` - `type_name`
- [ ] `crates/ui/src/window/actions/file_actions.rs:179` - `document`
- [ ] `crates/ui/src/window/actions/alignment_actions.rs:225` - `bounds`
- [ ] `crates/ui/src/export/image.rs:370` - `mut attrs` (アンderline)
- [ ] `crates/ui/src/export/svg.rs:298` - `mut attrs`

**工数**：20分 | **影響**：低 | **効果**：警告削減

### 1.3 未使用関数の評価
- [ ] `crates/ui/src/panels/property_handlers.rs:263` - `apply_alignment()`
  - 削除 or 実装？確認が必要
- [ ] `crates/ui/src/window/actions/common.rs:17` - `add_window_action_with_capture()`
  - 削除 or 実装？確認が必要

**工数**：30分 | **影響**：中 | **効果**：コード最適化

### 1.4 廃止予定 API の置き換え
- [ ] `FileChooserNative` → `FileDialog` (GTK 4.10+)
  - `crates/ui/src/dialogs/image_dialog.rs` （3箇所）
  - `crates/ui/src/io/file_dialog.rs`
- [ ] `gtk4::Dialog` → `ApplicationWindow` or `Window`
  - `crates/ui/src/dialogs/user_manual_dialog.rs`

**工数**：1時間 | **影響**：中 | **効果**：将来互換性

---

## Phase 2: エラーハンドリングの改善（優先度: 高）

### 2.1 エラーメッセージの統一
- [ ] `AppError` メッセージの英語化 or 日本語化統一
  - 現在：日本語 のみ
  - 確認：UI表示時は日本語、ログは英語が良い？
- [ ] ユーザーフレンドリーなメッセージ化
  - 技術的なエラーを隠す
  - アクション可能な提案を含める

**工数**：1時間 | **影響**：高 | **効果**：UX向上

### 2.2 ファイル I/O エラー処理
- [ ] ファイル保存失敗時の自動リカバリー
- [ ] ディスク容量不足の検出
- [ ] ファイルロック・アクセス権限エラーの処理
- [ ] ロールバック機構の実装

**工数**：1.5時間 | **影響**：高 | **効果**：データ保護

### 2.3 レンダリング エラー処理
- [ ] Cairo context エラーのキャッチ
- [ ] フォント不在時のフォールバック
- [ ] メモリ不足時の graceful degradation

**工数**：1時間 | **影響**：中 | **効果**：安定性向上

---

## Phase 3: テスト充実化（優先度: 高）

### 3.1 既存テスト のカバレッジ分析
- [ ] `cargo tarpaulin` or `cargo llvm-cov` でカバレッジ測定
- [ ] カバレッジ低いモジュール特定
- [ ] 目標：70% 以上

**工数**：30分 | **影響**：中 | **効果**：品質可視化

### 3.2 統合テスト の追加
- [ ] ドキュメント作成・保存・読み込みの E2E テスト
- [ ] ページ追加・削除・重複のシーケンシャルテスト
- [ ] 複雑な選択・配置操作のテスト

**工数**：2時間 | **影響**：高 | **効果**：回帰防止

### 3.3 UI テスト の基盤構築
- [ ] テンプレートダイアログの表示テスト
- [ ] ファイルダイアログの相互作用テスト
- [ ] パネル状態変化のテスト

**工数**：2時間 | **影響**：中 | **効果**：UI品質保証

---

## Phase 4: コード品質向上（優先度: 中）

### 4.1 長いメソッドの分割
- [ ] `crates/ui/src/canvas/rendering.rs` - 長いメソッド確認
- [ ] `crates/ui/src/window/actions/` - アクション関数の整理
- [ ] 1メソッド = 最大 50行 が目標

**工数**：2時間 | **影響**：低 | **効果**：可読性向上

### 4.2 重複コードの削減
- [ ] PDFエクスポート・PNGエクスポート共通部分抽出
- [ ] ダイアログボタン配置の共通化
- [ ] スタイル適用の統一

**工数**：1.5時間 | **影響**：低 | **効果**：保守性向上

### 4.3 型安全性の強化
- [ ] `Option<T>` の過度な unwrap() 削減
- [ ] エラーハンドリングの ? 演算子活用
- [ ] より詳細な Result 型定義

**工数**：1.5時間 | **影響**：中 | **効果**：堅牢性向上

### 4.4 命名規則の統一
- [ ] 変数名：snake_case 統一確認
- [ ] 関数名：動詞で始まる慣例確認
- [ ] 定数名：UPPER_SNAKE_CASE 統一

**工数**：1時間 | **影響**：低 | **効果**：可読性向上

---

## Phase 5: ドキュメント化（優先度: 中）

### 5.1 インラインコメント充実
- [ ] 複雑なアルゴリズムの説明追加
  - Dirty Region マージロジック
  - テキスト範囲スタイル適用アルゴリズム
  - グリッド・ガイドスナップロジック
- [ ] 目標：主要関数すべてにドキュメンテーション

**工数**：1.5時間 | **影響**：中 | **効果**：保守性向上

### 5.2 モジュールドキュメント
- [ ] 各モジュール先頭に `//!` ドキュメント
- [ ] 公開API の使用例追加
- [ ] 内部実装の設計意図説明

**工数**：1.5時間 | **影響**：中 | **効果**：学習曲線短縮

### 5.3 README 更新
- [ ] アーキテクチャ図の追加
- [ ] ビルド・実行手順の詳細化
- [ ] 開発者向けガイド作成

**工数**：1時間 | **影響**：低 | **効果**：オンボーディング向上

---

## Phase 6: パフォーマンス最適化（優先度: 低）

### 6.1 レンダリング最適化
- [ ] Dirty Region 追跡のプロファイリング
- [ ] 過度な再描画の検出・削減
- [ ] 大規模ドキュメント（100+ ページ）でのテスト

**工数**：2時間 | **影響**：中 | **効果**：応答性向上

### 6.2 メモリ使用量最適化
- [ ] ドキュメント保存時のメモリ使用量測定
- [ ] キャッシング戦略の検証
- [ ] 不要な clone() の削減

**工数**：1.5時間 | **影響**：低 | **効果**：スケーラビリティ

### 6.3 起動時間短縮
- [ ] アプリケーション起動プロファイリング
- [ ] テンプレート読み込みの遅延化
- [ ] データベース初期化の最適化

**工数**：1時間 | **影響**：低 | **効果**：UX向上

---

## 🎯 実装優先順序

### Tier 1（今すぐ）：重要・短時間
1. **Phase 1：コンパイル警告解消** (1.5時間)
2. **Phase 2.1：エラーメッセージ統一** (1時間)
3. **Phase 3.1：テストカバレッジ測定** (0.5時間)

**所要時間**：3時間 | **効果**：大

### Tier 2（今週）：重要・中期
1. **Phase 2.2-2.3：エラーハンドリング完全化** (2.5時間)
2. **Phase 3.2：統合テスト追加** (2時間)
3. **Phase 4.1-4.2：コード品質向上** (3.5時間)

**所要時間**：8時間 | **効果**：大

### Tier 3（今月）：改善・長期
1. **Phase 4.3-4.4：型安全性・命名** (2.5時間)
2. **Phase 5：ドキュメント化** (4時間)
3. **Phase 6：パフォーマンス最適化** (4.5時間)

**所要時間**：11時間 | **効果**：中

---

## 📊 見積サマリー

| Phase | 工数 | 優先度 | 効果 |
|-------|------|--------|------|
| Phase 1 | 1.5h | 高 | 品質 |
| Phase 2 | 3.5h | 高 | 安定性 |
| Phase 3 | 4.5h | 高 | 信頼性 |
| Phase 4 | 5.5h | 中 | 保守性 |
| Phase 5 | 4.0h | 中 | 学習性 |
| Phase 6 | 4.5h | 低 | 性能 |
| **合計** | **23.5h** | - | - |

**全工数**：23.5時間（約3営業日）

---

## ✅ 実装後の期待効果

- ✅ コンパイル警告：64 → 0
- ✅ テストカバレッジ：不明 → 70%+
- ✅ コード複雑度：低減
- ✅ ドキュメント完全性：向上
- ✅ ユーザー満足度：向上
- ✅ 長期保守性：大幅改善

---

## 🚀 v1.0 リリース準備

バグフィクス・リファクタリング完了後：

1. **ベータテスト**：教育現場での試行 (1週間)
2. **フィードバック収集**：改善点抽出
3. **最終調整**：Tier 1完了後に開始
4. **v1.0 リリース**：全テスト合格後

**目標日程**：2週間以内

---

## 📝 変更履歴

- 2024-11-06：ロードマップ作成（v0.9から v1.0へ）
