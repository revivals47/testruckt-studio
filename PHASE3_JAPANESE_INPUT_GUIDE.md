# Phase 3 日本語入力ガイド

## 概要

Testruct v0.1では、日本語テキスト入力を**ペースト経由**でサポートしています。

これは、macOS上のGTK4フレームワークの技術的制限（DrawingAreaウィジェットでのIME信号未対応）に対する実用的なワークアラウンドです。

## 使用方法

### テキスト要素への日本語入力

#### ステップ 1: テキスト編集モードに進入
1. テキスト要素を**ダブルクリック**して編集モードを開始します
2. テキスト要素の周囲に点線フレームが表示され、カーソルが表示されます

#### ステップ 2: 日本語テキストをペースト
1. 外部アプリケーション（メモ、メール、ブラウザなど）から日本語テキストをコピーします
2. Testruct内のテキスト編集ボックスで **Cmd+V** を押してペーストします
3. 日本語テキストがカーソル位置に挿入されます

#### ステップ 3: 編集の完了
- テキスト要素の外側をクリックするか **Escape** キーを押して編集を終了します

### 例

```
元のテキスト: "これはテストです"
カーソル位置: 4（末尾）

ペースト後: "これはテストです。追加テキスト"
```

## 機能

### ✅ サポートされている機能
- 日本語テキストのペースト（Cmd+V）
- マルチラインテキストの入力
- 日本語・英数字の混在テキスト
- 特殊文字・記号を含むテキスト
- カーソル位置の正確な管理
- テキスト削除（Backspace）
- テキスト移動（矢印キー）

### ❌ 現在サポートされていない機能
- リアルタイム日本語IME入力（キーボードから直接）
- 入力途中の候補表示（ライブプレビュー）
- ひらがな→漢字変換（IME経由）

## 代替方法

### 方法 1: 外部テキストエディタを使用
1. テキストエディタ（メモアプリ、VS Code など）を開く
2. 完成した日本語テキストを入力・編集
3. Testruct内のテキスト要素にペースト

### 方法 2: 日本語IMEのテキスト入力
1. システム環境設定から日本語IMEを有効にします
2. 別のアプリケーション（メモなど）で日本語を入力
3. テキストをコピーしてTestruct内にペースト

### 方法 3: キーボードショートカット（英数字）
- 直接キーボード入力でのASCII文字は完全にサポート
- 複数の言語を含むドキュメントには、部分的に日本語をペースト

## テクニック

### 効率的な編集ワークフロー
```
1. テキスト要素をダブルクリック → 編集モード開始
2. 既存テキストを Backspace で削除
3. 新しい日本語テキストを Cmd+V でペースト
4. 外側をクリック → 完了
```

### 複数言語の混在
```
例: "English テキスト English"

1. "English テキスト English" をテキストエディタで入力
2. コピー (Cmd+C)
3. Testruct内でペースト (Cmd+V)
```

## トラブルシューティング

### ペースト時に何も表示されない場合
- **原因**: クリップボード内のテキストが空の可能性
- **解決**: テキストエディタを開いて日本語テキストを入力し、再度コピーしてください

### テキスト編集モードに進入できない場合
- **原因**: テキスト要素の選択と編集の状態確認
- **解決**:
  1. テキスト要素を**1回クリック**して選択
  2. **2回クリック**して編集モードに進入

### カーソル位置がおかしい場合
- **原因**: マルチラインテキストでの行数計算
- **解決**: 矢印キー（↑↓←→）でカーソル位置を調整してください

## 技術詳細

### なぜペースト方式を採用したのか？

GTK4 (macOS版) は、カスタムDrawingAreaウィジェットを通じて日本語IMEのシグナルを正しくルーティングしません。

**標準的なGTK4 IMEフロー（Linux/Windows）:**
```
キー入力 → EventControllerKey → IMContext 信号発火 → テキスト挿入
```

**macOS DrawingAreaの現実:**
```
キー入力 → EventControllerKey → IMContext（信号なし）
  ↓
ネイティブmacOS IMEがキーをインターセプト
しかし DrawingArea には対応していない
```

### ワークアラウンド（現在の実装）
```
ペースト操作 → pbpaste実行 → クリップボード読み込み → テキスト挿入
```

これにより、ユーザーは任意のソースから日本語テキストを入力できます。

## 将来の改善

### 長期計画
1. **macOS Native Bridge** (objc2経由)
   - NSTextInputContextの直接統合
   - フルIMEサポート

2. **Linux対応**
   - 標準GTK4 IMEを活用
   - ibus、fcitxなどとの統合

3. **Windows対応**
   - TSAPI/Text Services Framework
   - 標準Windows IMEサポート

### 推定タイムライン
- Native Bridge: v0.2 (1-2 ヶ月後)
- Linux サポート: v0.3 (2-3 ヶ月後)
- Windows サポート: v0.4 (3-4 ヶ月後)

## フィードバック

日本語入力に関する問題や機能リクエストは、GitHubのIssueセクションで報告してください：

https://github.com/anthropics/testruct/issues

### レポート時に含める情報
- macOS バージョン
- 使用している日本語IME
- 入力しようとしたテキスト
- エラーメッセージ（ある場合）

## 参考資料

- [GTK4 Input Method Architecture](https://docs.gtk.org/gtk4/class.IMContext.html)
- [macOS Text Input Client Protocol](https://developer.apple.com/documentation/appkit/nstextinputclient)
- [Testruct GitHub Repository](https://github.com/anthropics/testruct)

---

**最終更新**: 2025年11月10日
**バージョン**: Phase 3 (v0.1.0)
